name: EAS Update (OTA)

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      message:
        description: 'Update message'
        required: false
        default: 'Update from GitHub Actions'

jobs:
  update:
    name: Publish OTA Update
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js (for EAS CLI)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Determine update message
        id: message
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            MSG="${{ github.event.inputs.message }}"
          else
            MSG="Update: ${{ github.event.head_commit.message }}"
          fi
          echo "msg=$MSG" >> $GITHUB_OUTPUT

      - name: Publish update
        run: |
          eas update --branch preview --message "${{ steps.message.outputs.msg }}" --non-interactive

