name: Lines of Code

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:

jobs:
  count-loc:
    name: Count Lines of Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install cloc
        run: sudo apt-get install -y cloc

      - name: Count lines of code
        run: |
          echo "## ðŸ“Š Lines of Code Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cloc . --vcs=git --exclude-dir=node_modules,dist,.expo,.next --exclude-ext=lock >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Detailed breakdown
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ By Directory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Directory | Files | Code | Comments | Blank |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|------|----------|-------|" >> $GITHUB_STEP_SUMMARY
          
          for dir in app components lib contexts hooks; do
            if [ -d "$dir" ]; then
              STATS=$(cloc "$dir" --csv --quiet 2>/dev/null | tail -1 || echo "0,0,0,0,0")
              FILES=$(echo "$STATS" | cut -d',' -f1)
              BLANK=$(echo "$STATS" | cut -d',' -f3)
              COMMENT=$(echo "$STATS" | cut -d',' -f4)
              CODE=$(echo "$STATS" | cut -d',' -f5)
              echo "| $dir/ | $FILES | $CODE | $COMMENT | $BLANK |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Output total
        run: |
          TOTAL=$(cloc . --vcs=git --exclude-dir=node_modules,dist,.expo,.next --csv --quiet 2>/dev/null | grep "SUM" | cut -d',' -f5 || echo "N/A")
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Total Lines of Code:** $TOTAL" >> $GITHUB_STEP_SUMMARY

