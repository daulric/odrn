name: Lines of Code

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:

jobs:
  count-loc:
    name: Count Lines of Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install tokei
        run: |
          curl -fsSL https://github.com/XAMPPRocky/tokei/releases/latest/download/tokei-x86_64-unknown-linux-gnu.tar.gz -o tokei.tar.gz
          tar -xzf tokei.tar.gz
          chmod +x tokei

      - name: Count lines of code
        id: loc
        run: |
          echo "## ðŸ“Š Lines of Code Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ./tokei . --exclude node_modules --exclude dist --exclude ios/Pods --exclude android/.gradle --exclude "*.lock" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Detailed breakdown
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ By Directory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Directory | Files | Lines |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|-------|" >> $GITHUB_STEP_SUMMARY
          
          # Count app directory
          APP_LOC=$(./tokei app --output json 2>/dev/null | jq '.Total.code // 0' || echo "0")
          APP_FILES=$(./tokei app --output json 2>/dev/null | jq '[.[] | select(.name != "Total") | .reports[].stats.code] | length' || echo "0")
          echo "| app/ | $APP_FILES | $APP_LOC |" >> $GITHUB_STEP_SUMMARY
          
          # Count components directory
          COMP_LOC=$(./tokei components --output json 2>/dev/null | jq '.Total.code // 0' || echo "0")
          echo "| components/ | - | $COMP_LOC |" >> $GITHUB_STEP_SUMMARY
          
          # Count lib directory
          LIB_LOC=$(./tokei lib --output json 2>/dev/null | jq '.Total.code // 0' || echo "0")
          echo "| lib/ | - | $LIB_LOC |" >> $GITHUB_STEP_SUMMARY
          
          # Count contexts directory
          CTX_LOC=$(./tokei contexts --output json 2>/dev/null | jq '.Total.code // 0' || echo "0")
          echo "| contexts/ | - | $CTX_LOC |" >> $GITHUB_STEP_SUMMARY
          
          # Count hooks directory
          HOOKS_LOC=$(./tokei hooks --output json 2>/dev/null | jq '.Total.code // 0' || echo "0")
          echo "| hooks/ | - | $HOOKS_LOC |" >> $GITHUB_STEP_SUMMARY

      - name: Output total
        run: |
          TOTAL=$(./tokei . --exclude node_modules --exclude dist --exclude ios/Pods --exclude android/.gradle --exclude "*.lock" --output json | jq '.Total.code')
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Total Lines of Code:** $TOTAL" >> $GITHUB_STEP_SUMMARY

